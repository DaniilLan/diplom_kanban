{% extends "base.html" %}

{% block title %}
Канбан-доска на Django, DRF & Alpine.js
{% endblock %}

{% block content %}

<body class="antialiased sans-serif bg-gray-900">
  <div x-data="board()" x-init="getData()" x-cloak class="flex flex-col min-h-screen border-t-8" :class="`border-${colorSelected.value}-700`">
    <div class="flex-1">

      <!-- Хедер -->
      <div class="bg-cover bg-center bg-no-repeat" :class="`bg-${colorSelected.value}-900`" :style="`background-image: url(${bannerImage})`">
        <div class="container mx-auto"></div>
        <img src="static/icon_web.png" alt="Иконка сайта" style="height: 100px; padding-left: 1rem;">
      </div>
      <!-- конец хедера -->

      <div class="container mx-auto px-4 py-4 -mt-40">

{% include 'settings.html' %}

        <!-- Главная -->
        <div x-show.immediate="showSettingsPage == false">
          <div x-show.transition="showSettingsPage == false">
            <!-- Приветствие -->
            <div class="flex justify-between items-center" style="padding-top: 4rem;">
              <div>
                <h1 class="text-xl md:text-2xl text-gray-300 font-semibold shake">
                  {% now "H" as current_time %}
                  {% if current_time|add:"0" < 12 %}
                   Доброе утро, {{ request.user.username }}
                  {% elif current_time|add:"0" > 17 %}
                   Добрый вечер, {{ request.user.username }}
                  {% else %}
                   Добрый день, {{ request.user.username }}
                  {% endif %}
                </h1>
                <div class="text-sm" :class="`text-${colorSelected.value}-400`">{% now 'SHORT_DATE_FORMAT' %}</div>
              </div>
              <div x-data="{ showSettingsPage: false }">
                <div class="flex justify-between">
                  <div>
                    <a @click.prevent="showSettingsPage = !showSettingsPage" href="#" class="rounded-lg px-3 py-2 font-medium inline-flex" :class="`text-${colorSelected.value}-500 bg-${colorSelected.value}-800 hover:bg-${colorSelected.value}-700`">
                      <i class="uil bx bxs-color-fill text-left mr-1" style="font-size: larger;"></i>Тема</a>
                    <a href="/logout" class="rounded-lg px-3 py-2 font-medium inline-flex items-center" :class="`text-${colorSelected.value}-500 bg-${colorSelected.value}-800 hover:bg-${colorSelected.value}-700`">
                      <i class="uil uil-sign-out-alt mr-1"></i>Выход</a>
                  </div>
                  <!-- Блок с цветами темы -->
                  <div x-show.transition="showSettingsPage" class="absolute top-0 mt-2 bg-gray-800 p-4 rounded-lg shadow-lg z-10 fade-enter fade-leave" style="top: 7rem; width: 14rem; right: 1rem;">
                    <div class="bg-gray-900 rounded-lg shadow-md" style="padding: 10px; max-width: 42rem;">
                      <div class="">
                        <div class="flex items-center">
                          <div>
                            <div class="px-1">
                              <div class="flex flex-wrap -mx-2 justify-center">
                                <template x-for="(color, index) in colors" :key="index">
                                  <div class="px-2" style="margin-top: 5px">
                                    <template x-if="colorSelected.value === color.value">
                                      <div class="w-8 h-8 inline-flex rounded-full cursor-pointer border-4 border-white" :style="`background: ${color.label}; box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);`"></div>
                                    </template>
                                    <template x-if="colorSelected.value != color.value">
                                      <div @click="colorSelected = color" @keydown.enter="colorSelected = color" role="checkbox" tabindex="0" :aria-checked="colorSelected" class="w-8 h-8 inline-flex rounded-full cursor-pointer border-4 border-gray-500 focus:outline-none focus:shadow-outline" :style="`background: ${color.label};`"></div>
                                    </template>
                                  </div>
                                </template>
                                <div style="padding-top: 1rem;">
                                  <button type="button" @click="saveSettings" class="text-white font-semibold focus:outline-none py-2 px-4 border border-transparent rounded-lg shadow-xs" :class="`bg-${colorSelected.value}-700 hover:bg-${colorSelected.value}-800`">
                                    Сохранить
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Конец блока Приветствие -->

            <!-- Канбан-доска -->
            <div style="padding-top: 3rem; padding-bottom: 2rem;">
            <form id="task-form">
              {% csrf_token %}
            </form>
              <div class="flex -mx-4 block overflow-x-auto pb-2">
                <template x-for="board in boards" :key="board">
                  <div class="w-1/2 md:w-1/4 px-4 flex-shrink-0 flex-grow">
                    <div class="bg-gray-800 pb-4 rounded-lg shadow overflow-y-auto overflow-x-hidden border-t-8" style="min-height: 100px" :class="{
                        'border-red-500': board === boards[0],
                        'border-yellow-500': board === boards[1],
                        'border-blue-500': board === boards[2],
                        'border-green-500': board === boards[3],
                      }">
                      <div class="flex justify-between items-center px-4 py-2 bg-gray-800 sticky top-0">
                        <div class="flex items-center">
                            <h2 x-text="board" class="font-medium text-gray-300 mr-2"></h2>
                            <div class="bg-gray-900 text-white text-xs font-bold rounded-lg h-8 w-8 flex items-center justify-center">
                                <span x-text="tasks.filter(t => t.boardName === board).length" class="font-medium text-gray-300">11</span>
                            </div>
                        </div>
                        <a @click.prevent="showModalAdd(board)" href="#" class="inline-flex items-center text-sm font-medium" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`">
                          <i class="uil uil-book-medical mr-1"></i>Добавить
                        </a>
                      </div>
                      <div class="px-4">
                        <div @dragover="onDragOver(event)" @drop="onDrop(event, board)" @dragenter="onDragEnter(event)" @dragleave="onDragLeave(event)" class="pt-2 pb-20 rounded-lg">
                          <template x-for="(t, taskIndex) in tasks.filter(t => t.boardName === board)" :key="taskIndex">
                            <div :id="t.uuid">
                              <div x-show="t.edit == false">
                                <div x-show="t.edit == false" class="bg-gray-900 rounded-lg shadow mb-3 p-2" draggable="true" @dragstart="onDragStart(event, t.uuid)">
                                  <div class="flex justify-between items-center">
                                      <a x-text="(t.typeTask === 'bug' ? 'BUG-' : 'TASK-') + t.task_id" @click.prevent="" href="#" class="inline-flex items-center text-sm font-medium" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`"></a>
                                      <div class="flex items-center">
                                          <i class="bx bxs-circle mr-1"
                                             :class="{
                                                 'text-red-500': t.priorityTask === 'high',
                                                 'text-yellow-500': t.priorityTask === 'medium',
                                                 'text-gray-500': t.priorityTask === 'low'
                                             }">
                                          </i>
                                      </div>
                                  </div>
                                  <div x-text="t.name" class="text-gray-300"></div>
                                    <div x-text="t.date" class="text-gray-500 text-xs mt-2"></div>
                                    <div class="item-center flex justify-between">
                                        <div class="text-left">
                                            <span x-text="t.totalMinutesSpent" class="text-gray-500 text-xs"></span>
                                            <span class="text-gray-500 text-xs">/</span>
                                            <span x-text="t.timeEstimateMinutes" class="text-gray-500 text-xs"></span>
                                        </div>
                                        <div class="text-right">
                                            <a class="uil uil-edit mr-1" @click.prevent="showModalEdit(board, t.uuid, t.name, t.description, t.typeTask, t.priorityTask, t.timeEstimateMinutes)" href="#" class="inline-flex items-center text-sm font-medium" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`">
                                            </a>
                                            <a class="uil bx bxs-trash mr-1" @click="removeTask(t.uuid)" href="#" class="inline-flex items-center text-sm font-medium" :class="'text-red-500 hover:text-red-600'">
                                            </a>
                                        </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
            <!-- конец Канбан-доски -->
          </div>
        </div>
        <!-- конец Главной -->
      </div>
    </div>

    <!-- Футер -->
    <div class="container mx-auto px-4 py-10">
      <p class="text-gray-600 text-center"><strong><i class="uil uil-edit mr-1"></i>Kanban</strong> работает на <a href="https://www.django-rest-framework.org/" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`">Django REST Framework</a> и <a href="https://alpinejs.dev/" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`">AlpineJS</a>.</p>
    </div>
    <!-- конец футера -->

    <!-- Добавление задачи -->
    <div class="fixed inset-0 flex h-screen w-full items-end md:items-center justify-center z-10" x-show.transition.opacity="openModalAdd">
      <div class="absolute inset-0 bg-white opacity-25"></div>

      <div class="md:p-4 mx-auto w-full flex-1 relative overflow-hidden" style="max-width: 85rem;">
        <div class="md:shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-600 hover:text-gray-900 inline-flex items-center justify-center cursor-pointer" x-on:click="openModalAdd = !openModalAdd">
          <i class="uil uil-times"></i>
        </div>

        <div class="w-full rounded-t-lg md:rounded-lg flex">
          <!-- Левая часть (60%) -->
          <div class="bg-gray-900 p-8 border-r-2 border-gray-700" style="width: 60%; ">
            <h2 class="font-bold text-2xl mb-6 text-gray-300">Новая задача для <span class="leading-normal border-b-2" :class="`text-${colorSelected.value}-600 border-${colorSelected.value}-200`" x-text="task.boardName"></span></h2>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-lg">Заголовок</label>
              <textarea
                class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                type="text"
                rows="2"
                x-model="name"
                style="font-size: 1.25rem;">
              </textarea>
              <hr class="border-gray-600 my-4">
              <label class="text-gray-300 block mb-1 font-bold text-lg">Описание</label>
              <textarea
                class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                type="text"
                rows="4"
                x-model="description"
                style="height: 25rem; line-height: 1.6;">
              </textarea>
            </div>

            <div class="mt-8 text-right">
              <button type="button" class="bg-white hover:bg-gray-400 text-gray-800 font-semibold focus:outline-none py-2 px-4 border border-gray-400 rounded-lg shadow-sm mr-2" @click="openModalAdd = !openModalAdd">
                Отмена
              </button>
              <button type="button" class="text-white font-semibold py-2 px-4 border border-transparent focus:outline-none rounded-lg shadow-sm" @click="addTask(name, task.boardName, description, typeTask, priorityTask, timeEstimateMinutes)" :class="`bg-${colorSelected.value}-700 hover:bg-${colorSelected.value}-800`">
                Сохранить
              </button>
            </div>
          </div>

          <!-- Правая часть (40%) -->
          <div class="bg-gray-800 p-8"  style="width: 40%;">
            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Тип</label>
              <select x-model="typeTask" class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500">
                <option selected>-</option>
                <option value="task">Задача</option>
                <option value="bug">Баг</option>
              </select>
            </div>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Приоритет</label>
              <select x-model="priorityTask" class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500">
                <option selected>-</option>
                <option value="low">Низкий</option>
                <option value="medium">Средний</option>
                <option value="high">Высокий</option>
              </select>
            </div>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Ответственный</label>
              <input
                type="text"
                class="bg-gray-800 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight"
                :value="`{{ request.user.username }}`"
                readonly
              />
            </div>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Оценка времени</label>
              <input
                type="text"
                x-model="timeEstimateMinutes"
                class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                placeholder="0д 0ч 0м"
              />
            </div>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Затраченное время</label>
              <input
                type="text"
                x-model="timeEstimateMinutes"
                class="bg-gray-800 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight"
                placeholder="0д 0ч 0м"
                readonly
              />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Изменение задачи -->
    <div class="fixed inset-0 flex h-screen w-full items-end md:items-center justify-center z-10" x-show="t.edit == true" x-show.transition.opacity="openModalEdit">
        <div class="absolute inset-0 bg-white opacity-25"></div>
        <div class="md:p-4 mx-auto w-full flex-1 relative overflow-hidden" style="max-width: 85rem;">
            <div class="md:shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-600 hover:text-gray-900 inline-flex items-center justify-center cursor-pointer" x-on:click="openModalEdit = !openModalEdit">
                <i class="uil uil-times"></i>
            </div>

            <div class="w-full rounded-t-lg md:rounded-lg flex">
                <!-- Левая часть (60%) с разделителем -->
                <div class="bg-gray-900 p-8 border-r-2 border-gray-700 relative" style="width: 60%;">
                    <h2 class="font-bold text-2xl mb-6 text-gray-300">Задача из <span class="leading-normal border-b-2" :class="`text-${colorSelected.value}-600 border-${colorSelected.value}-200`" x-text="task.boardName"></span></h2>

                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-lg">Заголовок</label>
                        <textarea
                            class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                            type="text"
                            rows="2"
                            x-model="task.name"
                            style="font-size: 1.25rem;">
                        </textarea>
                        <hr class="border-gray-600 my-4">
                        <label class="text-gray-300 block mb-1 font-bold text-lg">Описание</label>
                        <textarea
                            class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                            type="text"
                            rows="4"
                            x-model="task.description"
                            style="height: 25rem; line-height: 1.6;">
                        </textarea>
                    </div>

                    <div class="mt-8 text-right">
                        <button type="button" class="bg-white hover:bg-gray-400 text-gray-800 font-semibold focus:outline-none py-2 px-4 border border-gray-300 rounded-lg shadow-sm mr-2" @click="openModalEdit = !openModalEdit">
                            Отмена
                        </button>
                        <button type="button" class="text-white font-semibold py-2 px-4 border border-transparent focus:outline-none rounded-lg shadow-sm" @click="updateTask(task.uuid, task.name, task.description, task.typeTask, task.priorityTask, task.timeEstimateMinutes)" :class="`bg-${colorSelected.value}-700 hover:bg-${colorSelected.value}-800`">
                            Изменить
                        </button>
                    </div>
                </div>

                <!-- Правая часть (40%) -->
                <div class="bg-gray-800 p-8" style="width: 40%;">
                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Тип</label>
                        <select x-model="task.typeTask" class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500">
                            <option selected>-</option>
                            <option value="task">Задача</option>
                            <option value="bug">Баг</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Приоритет</label>
                        <select x-model="task.priorityTask" class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500">
                            <option selected>-</option>
                            <option value="low">Низкий</option>
                            <option value="medium">Средний</option>
                            <option value="high">Высокий</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Ответственный</label>
                        <input
                            type="text"
                            class="bg-gray-800 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight"
                            :value="`{{ request.user.username }}`"
                            readonly
                        />
                    </div>

                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Оценка времени</label>
                        <input
                            type="text"
                            x-model="task.timeEstimateMinutes"
                            class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                            placeholder="1д 1ч 1м"
                        />
                    </div>

                    <div class="mb-4" x-data="{ totalMinutesSpent: totalMinutesSpent }">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Затраченное время</label>
                        <select x-model="selectedTimeLog" @change="onTimeLogSelect" class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500">
                            <option value="" x-text="`${convertMinutesToTime(totalMinutesSpent)} - за все время`"></option>
                            <template x-for="log in taskTimeLogs" :key="log.uuid">
                                <option :value="log.uuid" x-text="`${convertMinutesToTime(log.minutesSpent)} - ${log.date}`"></option>
                            </template>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Комментарий</label>
                        <textarea
                            x-model="selectedTimeLogComment"
                            class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                            rows="3"
                            placeholder="Комментарий..."
                            readonly
                        ></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- конец формы -->

<script>
const csrftoken = document.querySelector('#task-form > input').value;
const api_client = axios.create({
    baseURL: '/api',
    headers: { 'X-CSRFToken': csrftoken },
});

const addTask = async (name, board, description, taskType, priorityTask, timeEstimate) => {
  try {
    // Преобразуем время из формата "4д 17ч 23м" в минуты
    const timeEstimateMinutes = parseTimeInput(timeEstimate);

    const res = await api_client.post('/tasks/', {
      name,
      boardName: board,
      description,
      typeTask: taskType,
      priorityTask,
      timeEstimateMinutes,  // Отправляем уже преобразованное значение
    });
    location.reload();
    console.log('Задача создана:', res.data);
  } catch (e) {
    console.error(e);
  }
};

const removeTask = async taskUuid => {
    try {
        const res = await api_client.delete(`/task/${taskUuid}`);
        location.reload();
    } catch (e) {
        console.error(e);
    }
};

const updateTask = async (taskUuid, taskName, taskDescription, typeTask, priorityTask, timeEstimate) => {
    try {
        // Преобразуем время из формата "4д 17ч 23м" в минуты
        const timeEstimateMinutes = parseTimeInput(timeEstimate);

        const res = await api_client.patch(`/task/${taskUuid}`,
            {
            uuid: taskUuid,
            name: taskName,
            description: taskDescription,
            typeTask: typeTask,
            priorityTask: priorityTask,
            timeEstimateMinutes: timeEstimateMinutes,
            }
        );
    location.reload();
    } catch (e) {
        console.error(e);
    }
};

function board() {
      return {
        showSettingsPage: false,
        openModalAdd: false,
        openModalEdit: false,
        bannerImage: '',
        colors: [{
            label: '#3182ce',
            value: 'blue'
          },
          {
            label: '#38a169',
            value: 'green'
          },
          {
            label: '#967bb6',
            value: 'purple'
          },
          {
            label: '#e53e3e',
            value: 'red'
          },
          {
            label: '#ffa500',
            value: 'orange'
          },
          {
            label: '#0B0B45',
            value: 'indigo'
          },
          {
            label: '#008080',
            value: 'teal'
          },
          {
            label: '#718096',
            value: 'gray'
          },
          {
            label: '#ffff00',
            value: 'yellow'
          }
        ],
        colorSelected: {
          label: '#3182ce',
          value: 'blue'
        },

        boards: [
          'Сделать',
          'В процессе',
          'На проверке',
          'Выполнено'
        ],
        task: {
          name: '',
          boardName: '',
          date: new Date(),
          uuid: '',
          description: '',
          typeTask: '',
          priorityTask: '',
          timeEstimateMinutes: '',
        },

        selectedTimeLog: null,
        selectedTimeLogDate: '',
        selectedTimeLogComment: '',
        selectedTimeLogMinutesSpent: '',
        taskTimeLogs: [],

        tasks: [],
        showModalAdd(board) {
          this.task.boardName = board;
          this.openModalAdd = true;
          setTimeout(() => this.$refs.taskName.focus(), 200);
        },

        tasks: [],
        showModalEdit(board, uuid, name, description, typeTask, priorityTask, timeEstimateMinutes) {
          this.task.boardName = board;
          this.task.uuid = uuid;
          this.task.name = name;
          this.task.description = description;
          this.task.typeTask = typeTask;
          this.task.priorityTask = priorityTask;
          this.task.timeEstimateMinutes = timeEstimateMinutes;
          this.openModalEdit = true;
          this.loadTimeLogs(uuid);
          setTimeout(() => this.$refs.taskName.focus(), 200);
        },

        loadTimeLogs(taskUuid) {
            console.log('Загрузка TimeLogs для задачи:', taskUuid);
            api_client.get(`/timelogs/task/${taskUuid}/`)
                .then(response => {
                    console.log('Получены TimeLogs:', response.data);
                    this.taskTimeLogs = response.data;

                    // Вычисляем общее количество минут
                    this.totalMinutesSpent = this.taskTimeLogs.reduce((total, log) => total + log.minutesSpent, 0);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке TimeLogs:', error);
                });
        },

        onTimeLogSelect() {
                // Если выбрана заглушка, очищаем комментарий
                if (this.selectedTimeLog === '') {
                    this.selectedTimeLogComment = '';
                } else {
                    // Иначе можно выполнить другие действия, например, загрузить комментарий
                    const selectedLog = this.taskTimeLogs.find(log => log.uuid === this.selectedTimeLog);
                    if (selectedLog) {
                        this.selectedTimeLogComment = selectedLog.comment || '';
                    }
                }
            },

        resetForm() {
            this.task = {
              boardName: '',
              name: '',
              description: '',
              typeTask: '',
              priorityTask: '',
              timeEstimateMinutes: ''
            };
          },

        getData() {
            const themeFromLocalStorage = JSON.parse(localStorage.getItem('KB-theme'));
            this.bannerImage = localStorage.getItem('KB-bannerImage') || '';
            this.colorSelected = themeFromLocalStorage || {
                label: '#3182ce',
                value: 'blue'
            };
            const tasksFromDjango = {{ tasks | safe }};
            const timelogsFromDjango = {{ timelogs | safe }};

            // Добавляем расчет затраченного времени для каждой задачи
            this.tasks = tasksFromDjango.map(t => {
                const taskTimelogs = timelogsFromDjango.filter(tl => tl.task === t.uuid);
                const totalMinutesSpent = taskTimelogs.reduce((acc, tl) => acc + tl.minutesSpent, 0);
                const timeSpent = convertMinutesToTime(totalMinutesSpent);
                const timeEstimate = convertMinutesToTime(t.timeEstimateMinutes);
                   return {
                        uuid: t.uuid,
                        name: t.name,
                        task_id: t.task_id,
                        boardName: t.boardName,
                        description: t.description,
                        date: t.date,
                        edit: false,
                        typeTask: t.typeTask,
                        priorityTask: t.priorityTask,
                        timeEstimateMinutes: timeEstimate,
                        totalMinutesSpent: timeSpent,
                };
            });
        },

        saveSettings() {
          const theme = JSON.stringify(this.colorSelected);
          localStorage.setItem('KB-theme', theme);
          localStorage.setItem('KB-bannerImage', this.bannerImage);
          this.showSettingsPage = false;
        },
        onDragStart(event, uuid) {
          event.dataTransfer.setData('text/plain', uuid);
          event.target.classList.add('opacity-5');
        },
        onDragOver(event) {
          event.preventDefault();
          return false;
        },
        onDragEnter(event) {
          event.currentTarget.classList.add('bg-gray-800');
        },
        onDragLeave(event) {
          event.currentTarget.classList.remove('bg-gray-800');
        },
        onDrop(event, boardName) {
          event.stopPropagation();
          event.preventDefault();
          event.target.classList.remove('bg-gray-200');
          const id = event.dataTransfer.getData('text');
          const taskIndex = this.tasks.findIndex(task => task.uuid === id);
          if (taskIndex > -1) {
            this.tasks[taskIndex].boardName = boardName;
            api_client.patch(`/task/${id}`, { boardName: boardName });
            this.tasks = [...this.tasks];
          }
          event.dataTransfer.clearData();
        },
        saveDataToLocalStorage(data, keyName) {
          var a = [];
          a = JSON.parse(localStorage.getItem(keyName)) || [];
          a.push(data);
          localStorage.setItem(keyName, JSON.stringify(a));
        },
       }
     }

</script>

</body>
 {% endblock %}
