{% extends "base.html" %}

{% block title %}
FlowBoard
{% endblock %}

{% block content %}

<body class="antialiased sans-serif bg-gray-900">
  <div x-data="board()" x-init="getData()" x-cloak class="flex flex-col min-h-screen border-t-8" :class="`border-${colorSelected.value}-700`">
    <div class="flex-1">

      <!-- Хедер -->
      <div class="bg-cover bg-center bg-no-repeat" :class="`bg-${colorSelected.value}-900`" :style="">
        <div class="container mx-auto flex items-center" style="padding-left: 1rem; margin-left: inherit;">
          <img src="static/icon_web.png" alt="Иконка сайта" style="height: 100px; width: 120px; flex-shrink: 0;">
            <div class="mx-4 flex flex-col items-center">
              <div class="h-1 w-16 mb-1 rounded-full" :class="`bg-${colorSelected.value}-600`"></div>
              <h1 class="text-3xl font-bold bg-clip-text text-transparent"
                  :class="`bg-gradient-to-r from-${colorSelected.value}-100 to-${colorSelected.value}-500`">
                FlowBoard
              </h1>
              <div class="h-1 w-16 mt-1 rounded-full" :class="`bg-${colorSelected.value}-600`"></div>
            </div>
          <div class="ml-4">
            <h1 class="text-xl md:text-2xl text-gray-300 font-semibold">
                {{ request.user.username }}
                <span x-show="userGroups.length > 0" class="text-gray-500" style="font-style: italic;font-weight: 350;">
                    - <span x-text="userGroups.map(group => group.name).join(', ')"></span>
                </span>
            </h1>
            <div class="text-sm" :class="`text-${colorSelected.value}-400`">{% now 'SHORT_DATE_FORMAT' %}</div>
          </div>
        </div>
      </div>

      <div class="container mx-auto px-4 py-4 -mt-40" style="max-width: 1920px;">

        {% include 'settings.html' %}

        <!-- Главная -->
        <div x-show.immediate="showSettingsPage == false">
          <div x-show.transition="showSettingsPage == false">
            <div class="flex justify-between items-center" style="padding-top: 4rem; margin-left: 120px; justify-content: end;">
              <div x-data="{
                  showSettingsPage: false,
                  buttonsVisible: false,
                  isRotating: false,
                  rotationDirection: 'left',
                  colorPickerVisible: false,
                  colorPickerAnimating: false,
                  closeAll() {
                    if (this.colorPickerVisible) {
                      this.colorPickerVisible = false;
                      setTimeout(() => {
                        this.buttonsVisible = false;
                        setTimeout(() => {
                          this.isRotating = false; // Останавливаем вращение только после закрытия ВСЕХ блоков
                        }, 300); // Ждем завершения анимации кнопок
                      }, 300); // Ждем завершения анимации цветов
                    } else {
                      this.buttonsVisible = false;
                      setTimeout(() => {
                        this.isRotating = false; // Останавливаем после анимации кнопок
                      }, 300);
                    }
                  }
                }">
                <div class="flex justify-end items-center">
                  <div class="h-10 w-1 mr-2 rounded-full" :class="`bg-${colorSelected.value}-600`"></div>

                  <!-- Основной контейнер -->
                  <div class="flex items-center">
                    <!-- Блок цветов -->
                    <div class="flex items-center overflow-hidden transition-all duration-300 ease-in-out"
                         x-ref="colorPickerContainer"
                         :style="colorPickerVisible ? 'max-width: 462px; opacity: 1; margin-right: 8px;' : 'max-width: 0; opacity: 0; margin-right: 0;'">
                      <div class="p-2 rounded-lg shadow-lg flex space-x-2 items-center" :class="`bg-${colorSelected.value}-900`">
                        <template x-for="(color, index) in colors" :key="index">
                          <div @click="colorSelected = color"
                               class="w-8 h-8 rounded-full cursor-pointer border-4"
                               :class="colorSelected.value === color.value ? 'border-white' : 'border-gray-500'"
                               :style="`background: ${color.label};`"></div>
                        </template>
                        <a @click="saveSettings; colorPickerVisible = false"
                           class="rounded-lg px-3 py-2 font-medium inline-flex items-center whitespace-nowrap ml-2"
                           :class="`text-${colorSelected.value}-500 bg-${colorSelected.value}-800 hover:bg-${colorSelected.value}-700`"
                           style="padding-left: .6rem; padding-right: .6rem; padding-top: .5rem; padding-bottom: .4rem;">
                          <i class="uil uil-check icon-check"></i>
                        </a>
                      </div>
                    </div>
                    <div class="h-10 w-1 mr-2 rounded-full" :class="`bg-${colorSelected.value}-600`"></div>

                    <!-- Кнопки меню -->
                    <div class="flex space-x-2 overflow-hidden transition-all duration-300 ease-in-out"
                         x-ref="buttonsContainer"
                         :style="buttonsVisible ? 'max-width: 400px; opacity: 1;' : 'max-width: 0; opacity: 0;'">
                      <a @click.prevent="colorPickerVisible = !colorPickerVisible"
                         href="#" class="items-center rounded-lg px-3 py-2 font-medium inline-flex whitespace-nowrap"
                         :class="`text-${colorSelected.value}-500 bg-${colorSelected.value}-800 hover:bg-${colorSelected.value}-700`">
                        <i class="uil bx bxs-color-fill text-left mr-1 icon-check" style="font-size: larger;"></i>Тема
                      </a>
                      <a href="/export-excel" class="items-center rounded-lg px-3 py-2 font-medium inline-flex whitespace-nowrap"
                         :class="`text-${colorSelected.value}-500 bg-${colorSelected.value}-800 hover:bg-${colorSelected.value}-700`">
                        <i class="uil uil-file-download mr-1 icon-check"></i>Отчет
                      </a>
                      <a href="/logout" class="items-center rounded-lg px-3 py-2 font-medium inline-flex whitespace-nowrap"
                         :class="`text-${colorSelected.value}-500 bg-${colorSelected.value}-800 hover:bg-${colorSelected.value}-700`">
                        <i class="uil uil-sign-out-alt mr-1 icon-check"></i>Выход
                      </a>
                    </div>

                    <!-- Шестеренка -->
                    <button @click="
                          if (!isRotating) {
                            isRotating = true;
                            if (buttonsVisible) {
                              closeAll();
                            } else {
                              buttonsVisible = true;
                              isRotating = false;
                            }
                          }
                        " class="ml-2 focus:outline-none flex items-center justify-center w-8 h-8">
                          <i class="bx bxs-cog"
                             :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`"
                             :style="`
                               transform: rotate(${buttonsVisible ? '-180deg' : '0deg'});
                               transition: transform 0.5s ease-in-out;
                               font-size: 2rem;
                               animation: ${isRotating ? 'spin 0.7s linear infinite' : 'none'};
                             `"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Конец блока Приветствие -->

            <!-- Канбан-доска -->
            <div style="padding-top: 3rem; padding-bottom: 2rem;">
              <form id="task-form">
                {% csrf_token %}
              </form>
              <div class="flex -mx-4 justify-center pb-2" style="padding-top: 1rem;">
                <template x-for="board in boards" :key="board">
                  <div class="w-full md:w-1/4 px-4 flex-shrink-0" style="max-width: 320px;"> <!-- Добавлен flex-shrink-0 и max-width -->
                    <div class="bg-gray-800 pb-4 rounded-lg shadow overflow-y-auto overflow-x-hidden border-t-8" style="min-height: 100px" :class="{
                            'border-red-500': board === boards[0],
                            'border-yellow-500': board === boards[1],
                            'border-blue-500': board === boards[2] || board === boards[3],
                            'border-purple-500': board === boards[4],
                            'border-green-500': board === boards[5]
                        }">
                      <div class="flex justify-between items-center px-4 py-2 bg-gray-800 sticky top-0">
                        <div class="flex items-center">
                            <h2 x-text="board" class="font-medium text-gray-300 mr-2"></h2>
                            <div class="bg-gray-900 text-white text-xs font-bold rounded-lg h-8 w-8 flex items-center justify-center">
                                <span x-text="tasks.filter(t => t.boardName === board).length" class="font-medium text-gray-300">11</span>
                            </div>
                        </div>
                        <a @click.prevent="showModalAdd(board)" href="#" class="inline-flex items-center text-sm font-medium" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`">
                          <i class="uil uil-book-medical mr-1"></i>Добавить
                        </a>
                      </div>
                      <div class="px-4">
                        <div @dragover="onDragOver(event)" @drop="onDrop(event, board)" @dragenter="onDragEnter(event)" @dragleave="onDragLeave(event)" class="pt-2 pb-20 rounded-lg">
                          <template x-for="(t, taskIndex) in tasks.filter(t => t.boardName === board)" :key="taskIndex">
                            <div :id="t.uuid">
                              <div x-show="t.edit == false">
                                <div x-show="t.edit == false" class="shake bg-gray-900 rounded-lg shadow mb-3 p-2" draggable="true" @dragstart="onDragStart(event, t.uuid)">
                                  <div class="flex justify-between items-center">
                                      <a x-text="(t.typeTask === 'bug' ? 'BUG-' : 'TASK-') + t.task_id" @click.prevent="showModalEdit(board, t.uuid, t.name, t.description, t.typeTask, t.priorityTask, t.timeEstimateMinutes, t.responsible)" href="#" class="inline-flex items-center text-sm font-medium" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`"></a>
                                      <div class="flex items-center">
                                          <i class="bx bxs-circle mr-1"
                                             :class="{
                                                 'text-red-500': t.priorityTask === 'high',
                                                 'text-yellow-500': t.priorityTask === 'medium',
                                                 'text-gray-500': t.priorityTask === 'low'
                                             }">
                                          </i>
                                      </div>
                                  </div>
                                  <div x-text="t.name" class="text-gray-300"></div>
                                    <div x-text="t.date" class="text-gray-500 text-xs mt-2"></div>
                                    <div class="text-left">
                                        <span x-text="t.totalMinutesSpent" class="text-gray-500 text-xs"></span>
                                        <span class="text-gray-500 text-xs">/</span>
                                        <span x-text="t.timeEstimateMinutes" class="text-gray-500 text-xs"></span>
                                    </div>
                                    <div class="item-center flex justify-between">
                                        <div class="text-left">
                                            <span x-text="t.responsible" class="text-gray-500 text-xs"></span>
                                        </div>
                                        <div class="text-right">
                                            <a class="uil uil-edit mr-1" @click.prevent="showModalEdit(board, t.uuid, t.name, t.description, t.typeTask, t.priorityTask, t.timeEstimateMinutes, t.responsible)" href="#" class="inline-flex items-center text-sm font-medium" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`">
                                            </a>
                                            <a class="uil bx bxs-trash mr-1" @click="openDeleteModal(t)" href="#" class="inline-flex items-center text-sm font-medium" :class="'text-red-500 hover:text-red-600'">
                                            </a>
                                        </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
              <div x-show="showDeleteModal" class="fixed inset-0 bg-black bg-opacity-50  flex items-center justify-center p-4">
                  <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-modal font-bold text-gray-300 mb-4">
                      <template x-if="selectedTaskForDeletion">
                        <span>
                          Удалить задачу
                            <span x-text="selectedTaskForDeletion ? (selectedTaskForDeletion.typeTask === 'bug' ? 'BUG-' : 'TASK-') + selectedTaskForDeletion.task_id: ''" :class="`text-${colorSelected.value}-500`"></span>?
                        </span>
                      </template>
                    </h3>
                    <div class="mb-4">
                      <h3 class="text-lg font-medium text-gray-300">Описание:</h3>
                      <p x-text="selectedTaskForDeletion?.name" class="ml-2 text-gray-300 break-words"></p>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" class="bg-white hover:bg-gray-400 text-gray-800 font-semibold focus:outline-none py-2 px-4 border border-gray-300 rounded-lg shadow-sm mr-2" @click="showDeleteModal = false">
                            Отмена
                        </button>
                        <button type="button" class="text-white font-semibold py-2 px-4 border border-transparent focus:outline-none rounded-lg shadow-sm" @click="removeTask(selectedTaskForDeletion?.uuid)" :class="`bg-red-600 hover:bg-red-700`">
                            Удалить
                        </button>
                    </div>
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Футер -->
    <div class="container mx-auto px-4 py-10">
      <p class="text-gray-600 text-center"><strong><i class="uil uil-edit mr-1"></i>Пример гибрида Kanban и Scrum,</strong> работает на <a href="https://www.django-rest-framework.org/" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`">Django REST Framework</a> и <a href="https://alpinejs.dev/" :class="`text-${colorSelected.value}-500 hover:text-${colorSelected.value}-600`">AlpineJS</a>.</p>
    </div>
    <!-- конец футера -->

    <!-- Добавление задачи -->
    <div class="fixed inset-0 flex h-screen w-full items-end md:items-center justify-center z-10" x-show.transition.opacity="openModalAdd" x-clock x-init="$watch('openModalAdd', val => $store.modals.toggleBodyScroll(val))">
      <div class="absolute inset-0 bg-white opacity-25" @click.self="openModalAdd = false"></div>
      <div class="md:p-4 mx-auto w-full flex-1 relative overflow-hidden" style="max-width: 85rem;">
        <div class="md:shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-600 hover:text-gray-900 inline-flex items-center justify-center cursor-pointer" x-on:click="openModalAdd = !openModalAdd">
          <i class="uil uil-times"></i>
        </div>

        <div class="w-full rounded-t-lg md:rounded-lg flex">
          <!-- Левая часть (65%) -->
          <div class="bg-gray-900 p-8 border-r-2 border-gray-700" style="width: 65%; ">
            <h2 class="font-bold text-2xl mb-6 text-gray-300">Новая задача для <span class="leading-normal border-b-2" :class="`text-${colorSelected.value}-600 border-${colorSelected.value}-200`" x-text="task.boardName"></span></h2>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-lg">Заголовок</label>
              <textarea
                class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 custom-scroll resize-none"
                type="text"
                rows="2"
                x-model="name"
                style="font-size: 1.25rem; overflow-y: auto;">
              </textarea>
              <hr class="border-gray-600 my-4">
              <label class="text-gray-300 block mb-1 font-bold text-lg">Описание</label>
              <textarea
                class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 custom-scroll resize-none"
                type="text"
                rows="4"
                x-model="description"
                style="height: 25rem; line-height: 1.6; overflow-y: auto;">
              </textarea>
            </div>

            <div class="mt-8 text-right">
              <button type="button" class="bg-white hover:bg-gray-400 text-gray-800 font-semibold focus:outline-none py-2 px-4 border border-gray-400 rounded-lg shadow-sm mr-2" @click="openModalAdd = !openModalAdd">
                Отмена
              </button>
              <button type="button" class="text-white font-semibold py-2 px-4 border border-transparent focus:outline-none rounded-lg shadow-sm" @click="addTask(name, task.boardName, description, typeTask, priorityTask, timeEstimateMinutes, responsible, selectedGroups)" :class="`bg-${colorSelected.value}-700 hover:bg-${colorSelected.value}-800`">
                Сохранить
              </button>
            </div>
          </div>

          <!-- Правая часть (35%) -->
          <div class="bg-gray-800 p-8"  style="width: 35%;">

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Тип</label>
              <div x-data="{ isOpen: false }" class="relative">
                <!-- Кнопка-триггер -->
                <button
                  @click="isOpen = !isOpen"
                  class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex justify-between items-center"
                >
                  <span x-text="{
                    'task': 'Задача',
                    'bug': 'Баг'
                  }[typeTask]"></span>
                  <i x-show="!isOpen" class="uil uil-angle-up transform transition-transform"></i>
                  <i x-show="isOpen" class="uil uil-angle-down transform transition-transform"></i>
                </button>

                <!-- Выпадающий список -->
                <div
                  x-show="isOpen"
                  @click.outside="isOpen = false"
                  class="absolute z-10 w-full mt-1 bg-gray-900 border-2 border-gray-600 rounded-lg overflow-hidden"
                >
                  <template x-for="option in [
                    {value: 'task', label: 'Задача'},
                    {value: 'bug', label: 'Баг'}
                  ]" :key="option.value">
                    <div
                      @click="typeTask = option.value; isOpen = false"
                      class="px-4 py-2 text-gray-300 hover:bg-gray-800 cursor-pointer flex justify-between items-center"
                      :class="{'bg-gray-800': typeTask === option.value}"
                    >
                      <span x-text="option.label"></span>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Приоритет</label>
              <div x-data="{ isOpen: false }" class="relative">
                <!-- Кнопка-триггер -->
                <button
                  @click="isOpen = !isOpen"
                  class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex items-center justify-between"
                >
                  <div class="flex items-center">
                    <span
                      class="w-2 h-2 rounded-full mr-2"
                      :class="{
                        'bg-red-500': priorityTask === 'high',
                        'bg-yellow-500': priorityTask === 'medium',
                        'bg-gray-500': priorityTask === 'low'
                      }"
                    ></span>
                    <span x-text="{
                      'high': 'Высокий',
                      'medium': 'Средний',
                      'low': 'Низкий'
                    }[priorityTask]"></span>
                  </div>
                  <i x-show="!isOpen" class="uil uil-angle-up transform transition-transform"></i>
                  <i x-show="isOpen" class="uil uil-angle-down transform transition-transform"></i>
                </button>

                <!-- Выпадающий список -->
                <div
                  x-show="isOpen"
                  @click.outside="isOpen = false"
                  class="absolute z-10 w-full mt-1 bg-gray-900 border-2 border-gray-600 rounded-lg overflow-hidden"
                >
                  <template x-for="option in [
                    {value: 'high', label: 'Высокий', color: 'red-500'},
                    {value: 'medium', label: 'Средний', color: 'yellow-500'},
                    {value: 'low', label: 'Низкий', color: 'gray-500'}
                  ]" :key="option.value">
                    <div
                      @click="priorityTask = option.value; isOpen = false"
                      class="px-4 py-2 text-gray-300 hover:bg-gray-800 cursor-pointer flex justify-between items-center"
                      :class="{'bg-gray-800': priorityTask === option.value}"
                    >
                      <div class="flex items-center">
                        <span
                          class="w-2 h-2 rounded-full mr-2"
                          :class="`bg-${option.color}`"
                        ></span>
                        <span x-text="option.label"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <div class="mb-4">
                <label class="text-gray-300 block mb-1 font-bold text-sm">Группы</label>
                <div x-data="{ isOpen: false }" class="relative">
                    <button
                        @click="isOpen = !isOpen"
                        class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex justify-between items-center"
                    >
                        <span x-text="
                            selectedGroups.length
                                ? userGroups
                                    .filter(g => selectedGroups.includes(g.uuid))
                                    .map(g => g.name)
                                    .join(', ')
                                : 'Выберите группы'"
                        :class="{'text-gray-500': !selectedGroups.length}">
                        </span>
                        <i x-show="!isOpen" class="uil uil-angle-up transform transition-transform"></i>
                        <i x-show="isOpen" class="uil uil-angle-down transform transition-transform"></i>
                    </button>

                    <div
                        x-show="isOpen"
                        @click.outside="isOpen = false"
                        class="absolute z-20 w-full mt-1 bg-gray-900 border-2 border-gray-600 rounded-lg max-h-48 overflow-y-auto"
                    >
                        <template x-for="group in userGroups" :key="group.uuid">
                            <label class="flex items-center px-4 py-2 hover:bg-gray-800 cursor-pointer">
                                <input
                                    type="checkbox"
                                    class="form-checkbox h-4 w-4 text-blue-500"
                                    x-model="selectedGroups"
                                    :value="group.uuid">
                                <span x-text="group.name" class="ml-2 text-gray-300"></span>
                            </label>
                        </template>
                    </div>
                </div>
            </div>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Ответственный</label>
              <div x-data="{ isOpen: false }" class="relative">
                <!-- Кнопка-триггер -->
                <button
                  @click="isOpen = !isOpen; $nextTick(() => $refs.dropdown.scrollTo({ top: 0, behavior: 'auto' }))"
                  class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex justify-between items-center"
                >
                  <span x-text="responsible || '{{ request.user.username }}'"></span>
                  <i x-show="!isOpen" class="uil uil-angle-up transform transition-transform"></i>
                  <i x-show="isOpen" class="uil uil-angle-down transform transition-transform"></i>
                </button>

                <!-- Выпадающий список -->
                <div
                  x-show="isOpen"
                  @click.outside="isOpen = false"
                  x-ref="dropdown"
                  class="absolute z-10 w-full mt-1 bg-gray-900 border-2 border-gray-600 rounded-lg overflow-hidden custom-scroll"
                  style="max-height: 164px; overflow-y: auto;"
                >
                  <!-- Используем sortedGroupMembers для отображения списка -->
                  <template x-for="user in sortedGroupMembers()" :key="user">
                    <div
                      @click="responsible = user; isOpen = false"
                      class="px-4 py-2 text-gray-300 hover:bg-gray-800 cursor-pointer flex justify-between items-center"
                      :class="{ 'bg-gray-800': responsible === user }"
                    >
                      <span x-text="user"></span>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Оценка времени</label>
              <input
                type="text"
                x-model="timeEstimateMinutes"
                class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                placeholder="0д 0ч 0м"
              />
            </div>

            <div class="mb-4">
              <label class="text-gray-300 block mb-1 font-bold text-sm">Затраченное время</label>
              <input
                type="text"
                class="bg-gray-800 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight"
                placeholder="0д 0ч 0м"
                readonly
              />
            </div>

            <div class="mb-4">
                <label class="text-gray-300 block mb-1 font-bold text-sm">Комментарий</label>
                <textarea
                    x-model="selectedTimeLogComment"
                    class="bg-gray-800 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight custom-scroll resize-none"
                    rows="3"
                    placeholder="Комментарий..."
                    readonly
                    style="height: 184px; overflow-y: auto;"
                ></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Изменение задачи -->
    <div class="fixed inset-0 flex h-screen w-full items-end md:items-center justify-center z-10" x-show="t.edit == true" x-show.transition.opacity="openModalEdit" x-cloak x-init="$watch('openModalEdit', val => $store.modals.toggleBodyScroll(val))">

        <div class="absolute inset-0 bg-white opacity-25" @click.self="openModalEdit = false"></div>
        <div class="md:p-4 mx-auto w-full flex-1 relative overflow-hidden" style="max-width: 85rem;">
            <div class="md:shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-600 hover:text-gray-900 inline-flex items-center justify-center cursor-pointer" x-on:click="openModalEdit = !openModalEdit">
                <i class="uil uil-times"></i>
            </div>

            <div class="w-full rounded-t-lg md:rounded-lg flex">
                <!-- Левая часть (65%) с разделителем -->
                <div class="bg-gray-900 p-8 border-r-2 border-gray-700 relative" style="width: 65%;">
                    <h2 class="font-bold text-2xl mb-6 text-gray-300">Задача из <span class="leading-normal border-b-2" :class="`text-${colorSelected.value}-600 border-${colorSelected.value}-200`" x-text="task.boardName"></span></h2>

                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-lg">Заголовок</label>
                        <textarea
                            class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 custom-scroll resize-none"
                            type="text"
                            rows="2"
                            x-model="task.name"
                            style="font-size: 1.25rem; overflow-y: auto;">
                        </textarea>
                        <hr class="border-gray-600 my-4">
                        <label class="text-gray-300 block mb-1 font-bold text-lg">Описание</label>
                        <textarea
                            class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 custom-scroll resize-none"
                            type="text"
                            rows="4"
                            x-model="task.description"
                            style="height: 30rem; line-height: 1.6; overflow-y: auto;">
                        </textarea>
                    </div>

                    <div class="mt-8 text-right">
                        <button type="button" class="bg-white hover:bg-gray-400 text-gray-800 font-semibold focus:outline-none py-2 px-4 border border-gray-300 rounded-lg shadow-sm mr-2" @click="openModalEdit = !openModalEdit">
                            Отмена
                        </button>
                        <button type="button" class="text-white font-semibold py-2 px-4 border border-transparent focus:outline-none rounded-lg shadow-sm" @click="updateTask(task.uuid, task.name, task.description, task.typeTask, task.priorityTask, task.timeEstimateMinutes, responsible)" :class="`bg-${colorSelected.value}-700 hover:bg-${colorSelected.value}-800`">
                            Сохранить
                        </button>
                    </div>
                </div>

                <!-- Правая часть (35%) -->
                <div class="bg-gray-800 p-8" style="width: 35%;">
                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Тип</label>
                        <div x-data="{ isOpen: false }" class="relative">
                            <!-- Кнопка-триггер -->
                            <button
                                @click="isOpen = !isOpen"
                                class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex justify-between items-center">
                                <span x-text="task.typeTask ? {
                                    'task': 'Задача',
                                    'bug': 'Баг'
                                }[task.typeTask] : '-'"></span>
                                <i x-show="!isOpen" class="uil uil-angle-up transform transition-transform"></i>
                                <i x-show="isOpen" class="uil uil-angle-down transform transition-transform"></i>
                            </button>

                            <!-- Выпадающий список -->
                            <div
                                x-show="isOpen"
                                @click.outside="isOpen = false"
                                class="absolute z-10 w-full mt-1 bg-gray-900 border-2 border-gray-600 rounded-lg overflow-hidden"
                            >
                                <template x-for="option in [
                                    {value: 'task', label: 'Задача'},
                                    {value: 'bug', label: 'Баг'}
                                ]" :key="option.value">
                                    <div
                                        @click="task.typeTask = option.value; isOpen = false"
                                        class="px-4 py-2 text-gray-300 hover:bg-gray-800 cursor-pointer"
                                        :class="{'bg-gray-800': task.typeTask === option.value}"
                                    >
                                        <span x-text="option.label"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                      <label class="text-gray-300 block mb-1 font-bold text-sm">Приоритет</label>
                      <div x-data="{ isOpen: false }" class="relative">
                        <!-- Кнопка-триггер -->
                        <button
                          @click="isOpen = !isOpen"
                          class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex items-center justify-between"
                        >
                          <div class="flex items-center">
                            <span
                              class="w-2 h-2 rounded-full mr-2"
                              :class="{
                                'bg-red-500': task.priorityTask === 'high',
                                'bg-yellow-500': task.priorityTask === 'medium',
                                'bg-gray-500': task.priorityTask === 'low',
                                'hidden': !task.priorityTask
                              }"
                            ></span>
                            <span
                              x-text="task.priorityTask ? {
                                'high': 'Высокий',
                                'medium': 'Средний',
                                'low': 'Низкий'
                              }[task.priorityTask] : '-'"
                            ></span>
                          </div>
                          <i x-show="!isOpen" class="uil uil-angle-up transform transition-transform"></i>
                          <i x-show="isOpen" class="uil uil-angle-down transform transition-transform"></i>
                        </button>

                        <!-- Выпадающий список -->
                        <div
                          x-show="isOpen"
                          @click.outside="isOpen = false"
                          class="absolute z-10 w-full mt-1 bg-gray-900 border-2 border-gray-600 rounded-lg overflow-hidden"
                        >
                          <template
                            x-for="option in [
                              {value: 'high', label: 'Высокий', color: 'red-500'},
                              {value: 'medium', label: 'Средний', color: 'yellow-500'},
                              {value: 'low', label: 'Низкий', color: 'gray-500'}
                            ]"
                            :key="option.value"
                          >
                            <div
                              @click="task.priorityTask = option.value; isOpen = false"
                              class="px-4 py-2 text-gray-300 hover:bg-gray-800 cursor-pointer flex justify-between items-center"
                              :class="{'bg-gray-800': task.priorityTask === option.value}"
                            >
                              <!-- Левая часть: цветовой индикатор и текст -->
                              <div class="flex items-center">
                                <span
                                  class="w-2 h-2 rounded-full mr-2"
                                  :class="`bg-${option.color}`"
                                  x-show="option.value"
                                ></span>
                                <span x-text="option.label"></span>
                              </div>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="text-gray-300 block mb-1 font-bold text-sm">Группы</label>
                      <div x-data="{ isOpen: false }" class="relative">
                        <button
                          @click="isOpen = !isOpen"
                          class="bg-gray-800 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex items-center justify-between"
                          disabled
                        >
                          <span x-text="taskGroups.map(g => g.name).join(', ')"></span>
                        </button>

                        <div
                          x-show="isOpen"
                          @click.outside="isOpen = false"
                          class="absolute z-20 w-full mt-2 bg-gray-900 border-2 border-gray-600 rounded-lg max-h-48 overflow-y-auto"
                        >
                          <template x-for="group in taskGroups" :key="group.uuid">
                            <div class="px-4 py-2 hover:bg-gray-800 cursor-pointer">
                              <span x-text="group.name" class="ml-2 text-gray-300"></span>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="text-gray-300 block mb-1 font-bold text-sm">Ответственный</label>
                      <div x-data="{ isOpen: false }" class="relative">
                        <!-- Кнопка-триггер -->
                        <button
                          @click="isOpen = !isOpen; $nextTick(() => $refs.dropdown.scrollTo({ top: 0, behavior: 'auto' }))"
                          class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex justify-between items-center"
                        >
                          <span x-text="responsible || '{{ request.user.username }}'"></span>
                          <i x-show="!isOpen" class="uil uil-angle-up transform transition-transform"></i>
                          <i x-show="isOpen" class="uil uil-angle-down transform transition-transform"></i>
                        </button>

                        <!-- Выпадающий список -->
                        <div
                          x-show="isOpen"
                          @click.outside="isOpen = false"
                          x-ref="dropdown"
                          class="absolute z-10 w-full mt-1 bg-gray-900 border-2 border-gray-600 rounded-lg overflow-hidden custom-scroll"
                          style="max-height: 164px; overflow-y: auto;"
                        >
                          <template x-for="user in sortedGroupMembers()" :key="user">
                            <div
                              @click="responsible = user; isOpen = false"
                              class="px-4 py-2 text-gray-300 hover:bg-gray-800 cursor-pointer"
                              :class="{ 'bg-gray-800': responsible === user }"
                            >
                              <span x-text="user"></span>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>

                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Оценка времени</label>
                        <input
                            type="text"
                            x-model="task.timeEstimateMinutes"
                            class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500"
                            placeholder="1д 1ч 1м"
                        />
                    </div>

                    <hr class="border-gray-600 my-4">

                     <div class="mb-4" x-data="{ isOpen: false, tempSelectedTimeLog: '' }">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Затраченное время</label>
                        <div class="relative">
                            <!-- Кнопка-триггер -->
                            <button
                                @click="isOpen = !isOpen; $nextTick(() => $refs.dropdown.scrollTo({ top: 0, behavior: 'auto' }))"
                                class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 text-left flex justify-between items-center"
                            >
                                <div class="flex justify-between items-center w-full">
                                    <template x-if="selectedTimeLog">
                                        <div class="flex items-center">
                                            <span x-text="`${convertMinutesToTime(taskTimeLogs.find(log => log.uuid === selectedTimeLog).minutesSpent)} - ${taskTimeLogs.find(log => log.uuid === selectedTimeLog).date}`"></span>
                                            <span class="text-gray-500 ml-2" x-text="taskTimeLogs.find(log => log.uuid === selectedTimeLog).owner_username" style="margin-left: 1rem;"></span>
                                        </div>
                                    </template>
                                    <template x-if="!selectedTimeLog">
                                        <span x-text="`${convertMinutesToTime(totalMinutesSpent)} - за все время`"></span>
                                    </template>
                                    <div class="flex items-center">
                                        <i x-show="!isOpen" class="uil uil-angle-up transform transition-transform"></i>
                                        <i x-show="isOpen" class="uil uil-angle-down transform transition-transform"></i>
                                    </div>
                                </div>
                            </button>

                            <!-- Выпадающий список -->
                            <div
                                x-show="isOpen"
                                @click.outside="isOpen = false; tempSelectedTimeLog = ''"
                                x-ref="dropdown"
                                class="absolute z-10 w-full mt-1 bg-gray-900 border-2 border-gray-600 rounded-lg overflow-hidden custom-scroll"
                                style="max-height: 221px; overflow-y: auto;"
                            >
                                <!-- Опция "Все время" -->
                                <div
                                    @click="selectedTimeLog = ''; isOpen = false; onTimeLogSelect()"
                                    class="px-4 py-2 text-gray-300 hover:bg-gray-800 cursor-pointer"
                                    :class="{'bg-gray-800': !selectedTimeLog}">
                                    <span x-text="`${convertMinutesToTime(totalMinutesSpent)} - за все время`"></span>
                                </div>

                                <!-- Список логов -->
                                <template x-for="log in sortedTaskTimeLogs()" :key="log.uuid">
                                    <div
                                        @click="tempSelectedTimeLog = log.uuid; selectedTimeLog = log.uuid; isOpen = false; onTimeLogSelect()"
                                        class="px-4 py-2 text-gray-300 hover:bg-gray-800 cursor-pointer"
                                        :class="{'bg-gray-800': selectedTimeLog === log.uuid}">
                                        <div class="flex justify-between items-center">
                                            <span x-text="`${convertMinutesToTime(log.minutesSpent)} - ${log.date}`"></span>
                                            <span class="text-gray-500 text-sm" x-text="log.owner_username"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="text-gray-300 block mb-1 font-bold text-sm">Комментарий</label>
                        <textarea
                            x-model="selectedTimeLogComment"
                            class="bg-gray-900 appearance-none border-2 border-gray-600 rounded-lg w-full py-2 px-4 text-gray-300 leading-tight focus:outline-none focus:bg-gray-900 focus:border-blue-500 custom-scroll resize-none"
                            rows="3"
                            placeholder="Комментарий..."
                            readonly
                            style="height: 183px; overflow-y: auto;"
                        ></textarea>
                    </div>

                    <div class="mt-8 text-right">
                        <button type="button"
                                class="text-white font-semibold py-2 px-4 border border-transparent focus:outline-none rounded-lg shadow-sm bg-gray-800 hover:bg-gray-700"
                                @click="openModalAddTime = true"
                                style="border: 2px solid #718096;">
                            Добавить затраченное время
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed inset-0 flex items-center justify-center z-20"
         x-show="openModalAddTime"
         x-transition.opacity
         x-clock>
        <div class="absolute inset-0 bg-black opacity-50" @click.self="openModalAddTime = false"></div>

        <div class="bg-gray-800 rounded-lg p-6 w-full relative z-30" style="max-width: 30rem;">
            <h3 class="text-modal font-bold text-gray-300 mb-4">Добавление затраченного времени</h3>

            <div class="mb-4">
                <label class="text-gray-300 block mb-2 font-medium">Затраченное время</label>
                <input type="text"
                       x-model="newTimeLog.duration"
                       class="bg-gray-900 border-2 border-gray-600 rounded-lg px-4 py-2 text-gray-300 focus:border-blue-500 focus:outline-none w-full"
                       placeholder="0д 0ч 0м">
            </div>

            <div class="mb-6">
                <label class="text-gray-300 block mb-2 font-medium">Комментарий</label>
                <textarea
                    x-model="newTimeLog.comment"
                    class="bg-gray-900 border-2 border-gray-600 rounded-lg w-full px-4 py-2 text-gray-300 focus:border-blue-500 focus:outline-none custom-scroll resize-none"
                    rows="3"
                    placeholder="Новый комментарий..."
                    style="height: 150px; overflow-y: auto;"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
                <button @click="openModalAddTime = false"
                        class="bg-white hover:bg-gray-400 text-gray-800 font-semibold focus:outline-none py-2 px-4 border border-gray-300 rounded-lg shadow-sm mr-2">
                    Отмена
                </button>
                <button @click="createTimeLog(task.uuid)"
                        class="text-white font-semibold py-2 px-4 border border-transparent focus:outline-none rounded-lg shadow-sm" :class="`bg-${colorSelected.value}-700 hover:bg-${colorSelected.value}-800`">
                    Добавить
                </button>
            </div>
        </div>
    </div>
</body>

<script>
const csrftoken = document.querySelector('#task-form > input').value;
const api_client = axios.create({
    baseURL: '/api',
    headers: { 'X-CSRFToken': csrftoken },
});

const addTask = async (name, board, description, taskType, priorityTask, timeEstimate, responsible, selectedGroups) => {
  try {
    // Валидация заголовка
    if (!name.trim()) {
      alert('Укажите название задачи');
      return;
    }

    // Валидация групп
    if (selectedGroups.length === 0) {
      alert('Выберите хотя бы одну группу');
      return;
    }

    // Валидация ответственного
    if (!responsible) {
      alert('Укажите ответственного');
      return;
    }

    // Валидация оценки времени
    const timeEstimateMinutes = parseTimeInput(timeEstimate);
    if (isNaN(timeEstimateMinutes)) {
      alert('Некорректный формат времени');
      return;
    }
    if (timeEstimateMinutes <= 0) {
      alert('Оценка времени должна быть больше 0');
      return;
    }

    // Валидация типа и приоритета
    if (!taskType || !priorityTask) {
      alert('Укажите тип и приоритет задачи');
      return;
    }

    const res = await api_client.post('/tasks/', {
      name: name.trim(),
      boardName: board,
      description: description.trim(),
      typeTask: taskType,
      priorityTask: priorityTask,
      timeEstimateMinutes,
      responsible: responsible,
      groups: selectedGroups,
    });

    if (res.status === 201) {
      openModalAdd = false;
      location.reload();
    }
  } catch (e) {
    console.error('Ошибка:', e.response?.data);
    alert(`Ошибка: ${e.response?.data?.detail || 'Серверная ошибка'}`);
  }
};

const removeTask = async taskUuid => {
    try {
        const res = await api_client.delete(`/task/${taskUuid}`);
        location.reload();
    } catch (e) {
        console.error(e);
    }
};


const updateTask = async (taskUuid, taskName, taskDescription, typeTask, priorityTask, timeEstimate, responsible) => {
  try {
    const timeEstimateMinutes = parseTimeInput(timeEstimate) || 0;

    const res = await api_client.patch(`/task/${taskUuid}`, {
      uuid: taskUuid,
      name: taskName,
      description: taskDescription,
      typeTask: typeTask,
      priorityTask: priorityTask,
      timeEstimateMinutes: timeEstimateMinutes,
      responsible: responsible,
    });
    if(res.status === 200) location.reload();
  } catch (e) {
    console.error('Ошибка обновления:', e.response?.data);
    alert('Ошибка сохранения изменений!');
  }
};

document.addEventListener('alpine:init', () => {
    Alpine.store('modals', {
        activeModal: null,

        toggleBodyScroll(isOpen) {
            if(isOpen) {
                document.body.classList.add('overflow-hidden', 'pr-[15px]');
            } else {
                document.body.classList.remove('overflow-hidden', 'pr-[15px]');
            }
        },
        toggleThemeToLight() {
          this.colorSelected = {
            label: '#718096',
            value: 'gray'
          };
          this.saveSettings();
        },
    });
});

function board() {
      return {
        showSettingsPage: false,
        openModalAdd: false,
        openModalEdit: false,
        openModalAddTime: false,
        showDeleteModal: false,
        selectedTaskForDeletion: null,
        groupUUID: '{{ group.uuid }}',
        newTimeLog: { duration: '', comment: '' },
        bannerImage: '',
        responsible: '{{ request.user.username }}',
        groupMembers: [],
        userGroups: [],
        selectedGroups: [],
        taskGroups: [],
            colors: [{
            label: '#3182ce',
            value: 'blue'
          },
          {
            label: '#38a169',
            value: 'green'
          },
          {
            label: '#008080',
            value: 'teal'
          },
          {
            label: '#ffa500',
            value: 'orange'
          },
          {
            label: '#ffff00',
            value: 'yellow'
          },
          {
            label: '#0B0B45',
            value: 'indigo'
          },
          {
            label: '#718096',
            value: 'gray'
          },
        ],
        colorSelected: {
          label: '#3182ce',
          value: 'blue'
        },

        boards: [
          'Сделать',
          'Переоткрыто',
          'В работе',
          'На проверке',
          'В тестировании',
          'Выполнено'
        ],
        task: {
          name: '',
          boardName: '',
          date: new Date(),
          uuid: '',
          description: '',
          timeEstimateMinutes: '',
          typeTask: 'task', // Добавьте это
          priorityTask: 'medium', // Добавьте это

        },

        selectedTimeLog: null,
        selectedTimeLogDate: '',
        selectedTimeLogComment: '',
        selectedTimeLogMinutesSpent: '',
        taskTimeLogs: [],

        tasks: [],
        showModalAdd(board) {
            this.name = '';
            this.description = '';
            this.typeTask = 'task';
            this.priorityTask = 'medium';
            this.timeEstimateMinutes = '';
            this.task.boardName = board;
            this.openModalAdd = true;
            this.selectedGroups = [];
            this.selectedTimeLogComment = '';

            this.selectedGroups = [];
            this.fetchGroupData().then(() => {
                this.fetchUserGroups();
                this.selectedGroup = this.userGroups[0];
                setTimeout(() => this.$refs.taskName.focus(), 200);
            });
        },

        showModalEdit(board, uuid, name, description, typeTask, priorityTask, timeEstimateMinutes, responsible) {
            this.task.boardName = board;
            this.task.uuid = uuid;
            this.task.name = name;
            this.task.description = description;
            this.task.typeTask = typeTask;
            this.task.priorityTask = priorityTask;
            this.task.timeEstimateMinutes = timeEstimateMinutes;
            this.selectedTimeLog = '';
            this.selectedTimeLogComment = '';
            this.task.responsible = responsible;
            this.openModalEdit = true;
            this.loadTimeLogs(uuid);

            // Загружаем пользователей групп конкретной задачи
            this.fetchGroupData(uuid).then(() => {
                this.responsible = responsible;
                this.fetchTaskGroups(uuid);
                setTimeout(() => this.$refs.taskName.focus(), 200);
            });
        },

        fetchGroupData(taskUUID = null) {
            const url = taskUUID
                ? `/api/tasks/${taskUUID}/members/`
                : '/api/user/groups/members/';

            return fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    this.groupMembers = data;
                })
                .catch(error => {
                    console.error('Error fetching members:', error);
                    this.groupMembers = [];
                });
        },

        fetchUserGroups() {
          fetch('/api/user/groups/')
            .then(response => response.json())
            .then(data => {
              this.userGroups = data;
              if (data.length > 0) {
                this.selectedGroup = data[0]; // Установка группы по умолчанию
              }
            });
        },

        fetchTaskGroups(taskUUID) {
          return fetch(`/api/tasks/${taskUUID}/groups/`)
            .then(response => response.json())
            .then(data => {
              this.taskGroups = data;
              this.selectedGroups = data; // Автовыбор текущих групп задачи
            });
        },

        onGroupSelect(event, group) {
          if (event.target.checked) {
            this.selectedGroups.push(group);
          } else {
            this.selectedGroups = this.selectedGroups.filter(g => g.uuid !== group.uuid);
          }
        },

        sortedGroupMembers() {
            if (!this.responsible) {
              return this.groupMembers;
            }
            // Сортируем список так, чтобы выбранный пользователь был на первом месте
            return [
              this.responsible,
              ...this.groupMembers.filter(user => user !== this.responsible)
            ];
        },

        sortedTaskTimeLogs() {
            if (!this.selectedTimeLog) {
              return this.taskTimeLogs;
            }
            const selectedLog = this.taskTimeLogs.find(log => log.uuid === this.selectedTimeLog);
            return [
              selectedLog,
              ...this.taskTimeLogs.filter(log => log.uuid !== this.selectedTimeLog)
            ];
        },

        loadTimeLogs(taskUuid) {
            console.log('Загрузка TimeLogs для задачи:', taskUuid);
            api_client.get(`/timelogs/task/${taskUuid}/`)
                .then(response => {
                    console.log('Получены TimeLogs:', response.data);
                    this.taskTimeLogs = response.data;
                    this.totalMinutesSpent = this.taskTimeLogs.reduce((total, log) => total + log.minutesSpent, 0);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке TimeLogs:', error);
                });
        },

        async createTimeLog(taskUuid) {
            try {
                const minutes = parseTimeInput(this.newTimeLog.duration);
                const response = await api_client.post(`/tasks/${taskUuid}/timelogs/`, {
                    minutesSpent: minutes,
                    comment: this.newTimeLog.comment
                });
                if (response.status === 201) {
                    this.openModalAddTime = false;
                    this.newTimeLog = { duration: '', comment: '' };
                    await this.loadTimeLogs(taskUuid); // Обновляем список логов
                }
            } catch (e) {
                console.error('Ошибка создания TimeLog:', e);
            }
        },

        openDeleteModal(task) {
            this.selectedTaskForDeletion = task;
            this.showDeleteModal = true;
        },

        async removeTask(taskUuid) {
            if (!taskUuid) return;

            try {
              const res = await api_client.delete(`/task/${taskUuid}`);
              this.showDeleteModal = false;
              location.reload();
            } catch (e) {
              console.error(e);
              this.showDeleteModal = false;
            }
        },

        onTimeLogSelect() {
                // Если выбрана заглушка, очищаем комментарий
                if (this.selectedTimeLog === '') {
                    this.selectedTimeLogComment = '';
                } else {
                    const selectedLog = this.taskTimeLogs.find(log => log.uuid === this.selectedTimeLog);
                    if (selectedLog) {
                        this.selectedTimeLogComment = selectedLog.comment || '';
                    }
                }
        },


        getData() {
            const themeFromLocalStorage = JSON.parse(localStorage.getItem('KB-theme'));
            this.bannerImage = localStorage.getItem('KB-bannerImage') || '';
            this.colorSelected = themeFromLocalStorage || {
                label: '#3182ce',
                value: 'blue'
            };
            this.fetchUserGroups();
            this.userGroups = [];
            const tasksFromDjango = {{ tasks | safe }};
            const timelogsFromDjango = {{ timelogs | safe }};

            this.tasks = tasksFromDjango.map(t => {
                const taskTimelogs = timelogsFromDjango.filter(tl => tl.task === t.uuid);
                const totalMinutesSpent = taskTimelogs.reduce((acc, tl) => acc + tl.minutesSpent, 0);
                const timeSpent = convertMinutesToTime(totalMinutesSpent);
                const timeEstimate = convertMinutesToTime(t.timeEstimateMinutes);

                return {
                    uuid: t.uuid,
                    name: t.name,
                    owner: t.owner,
                    task_id: t.task_id,
                    boardName: t.boardName,
                    description: t.description,
                    date: t.date,
                    edit: false,
                    typeTask: t.typeTask,
                    priorityTask: t.priorityTask,
                    timeEstimateMinutes: timeEstimate,
                    totalMinutesSpent: timeSpent,
                    responsible: t.responsible,
                };
            });
        },

        saveSettings() {
          const theme = JSON.stringify(this.colorSelected);
          localStorage.setItem('KB-theme', theme);
          localStorage.setItem('KB-bannerImage', this.bannerImage);
          this.showSettingsPage = false;
        },
        onDragStart(event, uuid) {
          event.dataTransfer.setData('text/plain', uuid);
          event.target.classList.add('opacity-5');
        },
        onDragOver(event) {
          event.preventDefault();
          return false;
        },
        onDragEnter(event) {
          event.currentTarget.classList.add('bg-gray-800');
        },
        onDragLeave(event) {
          event.currentTarget.classList.remove('bg-gray-800');
        },
        onDrop(event, boardName) {
          event.stopPropagation();
          event.preventDefault();
          event.target.classList.remove('bg-gray-200');
          const id = event.dataTransfer.getData('text');
          const taskIndex = this.tasks.findIndex(task => task.uuid === id);
          if (taskIndex > -1) {
            this.tasks[taskIndex].boardName = boardName;
            api_client.patch(`/task/${id}`, { boardName: boardName });
            this.tasks = [...this.tasks];
          }
          event.dataTransfer.clearData();
        },
        saveDataToLocalStorage(data, keyName) {
          var a = [];
          a = JSON.parse(localStorage.getItem(keyName)) || [];
          a.push(data);
          localStorage.setItem(keyName, JSON.stringify(a));
        },
       }
     }

</script>

</body>
{% endblock %}
